function countLabel(labels: string[], rekognitionPayload: any) {
  return rekognitionPayload.Labels.filter((label: { Name: string }) => labels.includes(label.Name)).reduce((acc, label) => acc + label.Instances.length, 0);
}

const main = async (events: EventPayload[]) => {
  console.info("O que chegou: ", events);
  const [event] = events;
  const data = JSON.parse(Buffer.from(event.data, 'base64').toString('utf-8'));
  const dynamoPayload = data?.dynamodb?.NewImage?.payload?.S;

  if (!dynamoPayload) throw new Error('No payload found');

  const { deviceCode, rekognitionPayload } = JSON.parse(dynamoPayload);

  const digestedObject = {
    deviceCode,
    passengerCount: countLabel(['Person'], rekognitionPayload),
  }

  return {
    statusCode: 200,
    body: digestedObject,
  };
};

console.info(main(
  [
    {
      eventSource: 'aws:kinesis',
      eventVersion: '1.0',
      eventID: 'shardId-000000000000:49643959657458665732904516390557341910181823797042085890',
      eventName: 'aws:kinesis:record',
      invokeIdentityArn: 'arn:aws:iam::033809494047:role/service-role/Amazon_EventBridge_Pipe_Execution_36f1c200',
      awsRegion: 'us-east-1',
      eventSourceARN: 'arn:aws:kinesis:us-east-1:033809494047:stream/lbl-dynamodb-insertion-stream',
      kinesisSchemaVersion: '1.0',
      partitionKey: '3DF89FF8F845FAA2121C5F7220739970',
      sequenceNumber: '49643959657458665732904516390557341910181823797042085890',
      data: 'eyJhd3NSZWdpb24iOiJ1cy1lYXN0LTEiLCJldmVudElEIjoiYTFlYTczMWEtOTdjMi00ZTAxLTg3NzAtMjEzMTdlMTI4MWM1IiwiZXZlbnROYW1lIjoiSU5TRVJUIiwidXNlcklkZW50aXR5IjpudWxsLCJyZWNvcmRGb3JtYXQiOiJhcHBsaWNhdGlvbi9qc29uIiwidGFibGVOYW1lIjoibHZiLWFuYWx5c2lzLXBheWxvYWQiLCJkeW5hbW9kYiI6eyJBcHByb3hpbWF0ZUNyZWF0aW9uRGF0ZVRpbWUiOjE2OTMwNjYwNTc4MjAsIktleXMiOnsiaWQiOnsiUyI6InNqVnZWTm1pYjA0b1FIUmNLRW82ZyJ9fSwiTmV3SW1hZ2UiOnsicGF5bG9hZCI6eyJTIjoie1wiZGV2aWNlQ29kZVwiOlwiY2xscHFkdHRnMDAwMWxqdWJ2bmJzenl3ZlwiLFwicmVrb2duaXRpb25QYXlsb2FkXCI6e1wiJG1ldGFkYXRhXCI6e1wiaHR0cFN0YXR1c0NvZGVcIjoyMDAsXCJyZXF1ZXN0SWRcIjpcIjU2OThiZTczLTY1MjAtNDBjYS05NzQ2LWFkZDVmMWFjOTFlY1wiLFwiYXR0ZW1wdHNcIjoxLFwidG90YWxSZXRyeURlbGF5XCI6MH0sXCJMYWJlbE1vZGVsVmVyc2lvblwiOlwiMy4wXCIsXCJMYWJlbHNcIjpbe1wiQWxpYXNlc1wiOlt7XCJOYW1lXCI6XCJIdW1hblwifV0sXCJDYXRlZ29yaWVzXCI6W3tcIk5hbWVcIjpcIlBlcnNvbiBEZXNjcmlwdGlvblwifV0sXCJDb25maWRlbmNlXCI6OTkuNzMzODk0MzQ4MTQ0NTMsXCJJbnN0YW5jZXNcIjpbe1wiQm91bmRpbmdCb3hcIjp7XCJIZWlnaHRcIjowLjUzNDM0NzgzMjIwMjkxMTQsXCJMZWZ0XCI6MC41NDgzNTk4NzA5MTA2NDQ1LFwiVG9wXCI6MC40NjI1NTkxOTMzNzI3MjY0NCxcIldpZHRoXCI6MC40NTE1NTQ5ODM4NTQyOTM4fSxcIkNvbmZpZGVuY2VcIjo5OS43MzM4OTQzNDgxNDQ1M30se1wiQm91bmRpbmdCb3hcIjp7XCJIZWlnaHRcIjowLjM2NjE2ODUyODc5NTI0MjMsXCJMZWZ0XCI6MC4wOTE2MzgyNTIxMzkwOTE0OSxcIlRvcFwiOjAuNjMyNDgxODczMDM1NDMwOSxcIldpZHRoXCI6MC40MzQxMjQxMTIxMjkyMTE0fSxcIkNvbmZpZGVuY2VcIjo5OS42NTczMzMzNzQwMjM0NH0se1wiQm91bmRpbmdCb3hcIjp7XCJIZWlnaHRcIjowLjE1MzAzOTI3NjU5OTg4NDAzLFwiTGVmdFwiOjAuMTM3OTM0ODQ4NjY2MTkxMSxcIlRvcFwiOjAuMzMyMTMyNjM3NTAwNzYyOTQsXCJXaWR0aFwiOjAuMTAzNzc5NTMyMDE1MzIzNjR9LFwiQ29uZmlkZW5jZVwiOjk5LjQxMDg4MTA0MjQ4MDQ3fSx7XCJCb3VuZGluZ0JveFwiOntcIkhlaWdodFwiOjAuMjc2NzQ1NzM2NTk4OTY4NSxcIkxlZnRcIjowLjAwMDA3MDIzNzYyMDA5MzM5NDA3LFwiVG9wXCI6MC4zODQ4MDQ3NTU0NDkyOTUwNCxcIldpZHRoXCI6MC4yMzk0MjIwOTc4MDIxNjIxN30sXCJDb25maWRlbmNlXCI6OTkuMzkzNzUzMDUxNzU3ODF9LHtcIkJvdW5kaW5nQm94XCI6e1wiSGVpZ2h0XCI6MC4xNjgwMzEzMzQ4NzcwMTQxNixcIkxlZnRcIjowLjcwOTcxNzgxMDE1Mzk2MTIsXCJUb3BcIjowLjI5MTk5OTU3ODQ3NTk1MjE1LFwiV2lkdGhcIjowLjE1NTM2MTM5OTA1NDUyNzI4fSxcIkNvbmZpZGVuY2VcIjo5OS4zNzY0MTkwNjczODI4MX0se1wiQm91bmRpbmdCb3hcIjp7XCJIZWlnaHRcIjowLjIyMTYxODE0NTcwNDI2OTQsXCJMZWZ0XCI6MC4yMzU4NjQ5NjcxMDc3NzI4MyxcIlRvcFwiOjAuNDQyMzg3OTA4Njk3MTI4MyxcIldpZHRoXCI6MC4yMTUzNzA5MjMyODA3MTU5NH0sXCJDb25maWRlbmNlXCI6OTkuMzQwMDQyMTE0MjU3ODF9LHtcIkJvdW5kaW5nQm94XCI6e1wiSGVpZ2h0XCI6MC41NDk0MDg1NTUwMzA4MjI4LFwiTGVmdFwiOjAuNTIxMTAzMzgyMTEwNTk1NyxcIlRvcFwiOjAuMzEyNzk5MTg1NTE0NDUwMSxcIldpZHRoXCI6MC4xNzE5MzM2NjU4NzE2MjAxOH0sXCJDb25maWRlbmNlXCI6OTkuMTQ5MTAxMjU3MzI0MjJ9LHtcIkJvdW5kaW5nQm94XCI6e1wiSGVpZ2h0XCI6MC4yNjQ5OTY1ODgyMzAxMzMwNixcIkxlZnRcIjowLjg3MTkyODk4OTg4NzIzNzUsXCJUb3BcIjowLjM0MTQwNTc0OTMyMDk4MzksXCJXaWR0aFwiOjAuMTI3Nzg2Nzg1MzY0MTUxfSxcIkNvbmZpZGVuY2VcIjo5OS4wMzA5OTgyMjk5ODA0N30se1wiQm91bmRpbmdCb3hcIjp7XCJIZWlnaHRcIjowLjE0NzczMDY2MzQxODc2OTg0LFwiTGVmdFwiOjAuMjAzNzI4NDgyMTI3MTg5NjQsXCJUb3BcIjowLjI0ODA0Njg0NTE5NzY3NzYsXCJXaWR0aFwiOjAuMTIxNzMxOTUxODMyNzcxM30sXCJDb25maWRlbmNlXCI6OTguOTc1MjUwMjQ0MTQwNjJ9LHtcIkJvdW5kaW5nQm94XCI6e1wiSGVpZ2h0XCI6MC4xMDcwMDQxNDMyOTc2NzIyNyxcIkxlZnRcIjowLjY2MDk3NTYzNTA1MTcyNzMsXCJUb3BcIjowLjI3NzcwNDQxNzcwNTUzNTksXCJXaWR0aFwiOjAuMTEwNTYxOTgxNzk3MjE4MzJ9LFwiQ29uZmlkZW5jZVwiOjk4LjY3NzExNjM5NDA0Mjk3fSx7XCJCb3VuZGluZ0JveFwiOntcIkhlaWdodFwiOjAuNDAyOTQ3NDI1ODQyMjg1MTYsXCJMZWZ0XCI6MC4zNDkzOTkxNDk0MTc4NzcyLFwiVG9wXCI6MC4yNTUwMzU2Njg2MTE1MjY1LFwiV2lkdGhcIjowLjE1MDM1NzczODEzNzI0NTE4fSxcIkNvbmZpZGVuY2VcIjo5OC42NzExMzQ5NDg3MzA0N30se1wiQm91bmRpbmdCb3hcIjp7XCJIZWlnaHRcIjowLjIxNDgzODcxMzQwNzUxNjQ4LFwiTGVmdFwiOjAuMDAwMDgxODkwODU5MjkxODg4NzcsXCJUb3BcIjowLjc4NDc0NzQ4MTM0NjEzMDQsXCJXaWR0aFwiOjAuMDQ1ODA3OTg3NDUxNTUzMzQ1fSxcIkNvbmZpZGVuY2VcIjo5OC4yNjI4MzI2NDE2MDE1Nn0se1wiQm91bmRpbmdCb3hcIjp7XCJIZWlnaHRcIjowLjE3Nzk3MTc5NTIwMTMwMTU3LFwiTGVmdFwiOjAuNDIyMDIwNDA1NTMwOTI5NTcsXCJUb3BcIjowLjIyNTg1OTAxNjE4MDAzODQ1LFwiV2lkdGhcIjowLjA4OTkyNjE4MzIyMzcyNDM3fSxcIkNvbmZpZGVuY2VcIjo5Ny45MTUyNTI2ODU1NDY4OH0se1wiQm91bmRpbmdCb3hcIjp7XCJIZWlnaHRcIjowLjE1NzE5ODAxMTg3NTE1MjYsXCJMZWZ0XCI6MC41MTM0MDkyNTY5MzUxMTk2LFwiVG9wXCI6MC4xOTkzOTcyMzYxMDg3Nzk5LFwiV2lkdGhcIjowLjA2NzY1MzQ2MjI5MDc2Mzg1fSxcIkNvbmZpZGVuY2VcIjo5Ny44MTg3MjU1ODU5Mzc1fSx7XCJCb3VuZGluZ0JveFwiOntcIkhlaWdodFwiOjAuMjY3MzEwNjQ5MTU2NTcwNDMsXCJMZWZ0XCI6MC41MTI4MzI3MDEyMDYyMDczLFwiVG9wXCI6MC4yMzY4NzA1NzE5NzA5Mzk2NCxcIldpZHRoXCI6MC4xMTIzODYxMjk3OTY1MDQ5N30sXCJDb25maWRlbmNlXCI6OTcuMTcyNzgyODk3OTQ5MjJ9LHtcIkJvdW5kaW5nQm94XCI6e1wiSGVpZ2h0XCI6MC4wOTIyMDE3OTE3MDM3MDEwMixcIkxlZnRcIjowLjY2MjE4ODQ3MDM2MzYxNjksXCJUb3BcIjowLjI0NTU4NTQ1NjQ5MDUxNjY2LFwiV2lkdGhcIjowLjA3MDk5MjY2MzUwMjY5MzE4fSxcIkNvbmZpZGVuY2VcIjo5Ni40MTU3MDI4MTk4MjQyMn0se1wiQm91bmRpbmdCb3hcIjp7XCJIZWlnaHRcIjowLjEwNzQxMjIxMTU5Njk2NTc5LFwiTGVmdFwiOjAuMjg3ODQ1MjI0MTQyMDc0NixcIlRvcFwiOjAuMjMzNTk5NDM5MjYzMzQzOCxcIldpZHRoXCI6MC4wOTE0ODE2MjYwMzM3ODI5Nn0sXCJDb25maWRlbmNlXCI6OTYuMjUyODM4MTM0NzY1NjJ9LHtcIkJvdW5kaW5nQm94XCI6e1wiSGVpZ2h0XCI6MC4wNTYyNjg2MTc1MTA3OTU1OSxcIkxlZnRcIjowLjYzOTMzMjc3MTMwMTI2OTUsXCJUb3BcIjowLjIxODQ1ODUwMzQ4NDcyNTk1LFwiV2lkdGhcIjowLjAzODk0Nzc5MDg2MTEyOTc2fSxcIkNvbmZpZGVuY2VcIjo5NS41NDg0MDA4Nzg5MDYyNX0se1wiQm91bmRpbmdCb3hcIjp7XCJIZWlnaHRcIjowLjA4MTA5MTg2NTg5NzE3ODY1LFwiTGVmdFwiOjAuMzU5MjM5NDg4ODQwMTAzMTUsXCJUb3BcIjowLjE5ODQ0OTA5MDEyMzE3NjU3LFwiV2lkdGhcIjowLjA0MTk3MjE2MDMzOTM1NTQ3fSxcIkNvbmZpZGVuY2VcIjo5NC42NjgyMDUyNjEyMzA0N30se1wiQm91bmRpbmdCb3hcIjp7XCJIZWlnaHRcIjowLjA2ODQ2ODk4MDQ5MTE2MTM1LFwiTGVmdFwiOjAuMzMxNzA3OTU0NDA2NzM4MyxcIlRvcFwiOjAuMjA3MjgyMzc5MjY5NTk5OTEsXCJXaWR0aFwiOjAuMDM0NzY0MzI3MTA4ODYwMDE2fSxcIkNvbmZpZGVuY2VcIjo5NC42MDIwMjc4OTMwNjY0fSx7XCJCb3VuZGluZ0JveFwiOntcIkhlaWdodFwiOjAuMDUxODk4Nzc3NDg0ODkzOCxcIkxlZnRcIjowLjU4Mzg0NDk1OTczNTg3MDQsXCJUb3BcIjowLjE2NzU1NzQxODM0NjQwNTAzLFwiV2lkdGhcIjowLjAyNjg3Mzc0MTI5ODkxMzk1Nn0sXCJDb25maWRlbmNlXCI6OTMuMjI0ODkxNjYyNTk3NjZ9LHtcIkJvdW5kaW5nQm94XCI6e1wiSGVpZ2h0XCI6MC4wNDAwMDA5MTU1MjczNDM3NSxcIkxlZnRcIjowLjI4NDQ3MDM3OTM1MjU2OTYsXCJUb3BcIjowLjE5ODYyMTgyNDM4MzczNTY2LFwiV2lkdGhcIjowLjA0Mzc4Mjk3OTI0OTk1NDIyNH0sXCJDb25maWRlbmNlXCI6OTIuMjM5NTI0ODQxMzA4Nn0se1wiQm91bmRpbmdCb3hcIjp7XCJIZWlnaHRcIjowLjA2OTk5OTEwNjIyODM1MTU5LFwiTGVmdFwiOjAuNTg5NzMyODI1NzU2MDczLFwiVG9wXCI6MC4xODU0NzUzMzQ1MjUxMDgzNCxcIldpZHRoXCI6MC4wNTQ3OTk4ODA4MzI0MzM3fSxcIkNvbmZpZGVuY2VcIjo5MS44OTI1NzA0OTU2MDU0N30se1wiQm91bmRpbmdCb3hcIjp7XCJIZWlnaHRcIjowLjA3MDQwMDY5MjUyMjUyNTc5LFwiTGVmdFwiOjAuNjcxNjE3MDMxMDk3NDEyMSxcIlRvcFwiOjAuMjI2NzYwMTA0Mjk4NTkxNixcIldpZHRoXCI6MC4wMzg3MjgyNTU3Nzg1NTExfSxcIkNvbmZpZGVuY2VcIjo5MS43MjMzNzM0MTMwODU5NH0se1wiQm91bmRpbmdCb3hcIjp7XCJIZWlnaHRcIjowLjExMjgwMjA1MTAwNzc0NzY1LFwiTGVmdFwiOjAuNTE0Njc3NzYyOTg1MjI5NSxcIlRvcFwiOjAuMTczMTI5Mzk0NjUwNDU5MyxcIldpZHRoXCI6MC4wNjgwNjkyMjcwMzk4MTR9LFwiQ29uZmlkZW5jZVwiOjkxLjEzMzM5MjMzMzk4NDM4fSx7XCJCb3VuZGluZ0JveFwiOntcIkhlaWdodFwiOjAuMDM4Nzg1MDU1Mjc5NzMxNzUsXCJMZWZ0XCI6MC4zNTg3MDk3MjI3NTczMzk1LFwiVG9wXCI6MC4xODE3NjE3NDE2MzgxODM2LFwiV2lkdGhcIjowLjAyNjA1OTY4NTI3NDk1ODYxfSxcIkNvbmZpZGVuY2VcIjo4OS45NjU0OTk4Nzc5Mjk2OX0se1wiQm91bmRpbmdCb3hcIjp7XCJIZWlnaHRcIjowLjA0NDA4MDAyMjcyMjQ4MjY4LFwiTGVmdFwiOjAuNDM1ODE4NTIzMTY4NTYzODQsXCJUb3BcIjowLjE4NDQyNzAwODAzMjc5ODc3LFwiV2lkdGhcIjowLjAzNTY2NjEyMzAzMjU2OTg4NX0sXCJDb25maWRlbmNlXCI6ODkuODM5NDY5OTA5NjY3OTd9LHtcIkJvdW5kaW5nQm94XCI6e1wiSGVpZ2h0XCI6MC4wOTQxOTIxMjQ5MDMyMDIwNixcIkxlZnRcIjowLjUwODQ4ODU5NTQ4NTY4NzMsXCJUb3BcIjowLjE2NzU3MjIwMDI5ODMwOTMzLFwiV2lkdGhcIjowLjA0MzUzNjk4NzE1NTY3NTg5fSxcIkNvbmZpZGVuY2VcIjo4OS40NDczNDE5MTg5NDUzMX0se1wiQm91bmRpbmdCb3hcIjp7XCJIZWlnaHRcIjowLjA0MTk0MDM0NjM2MDIwNjYwNCxcIkxlZnRcIjowLjM3NTE2OTU3NTIxNDM4NixcIlRvcFwiOjAuMTY0OTYxOTYzODkxOTgzMDMsXCJXaWR0aFwiOjAuMDI5MjI5MzE2ODYwNDM3MzkzfSxcIkNvbmZpZGVuY2VcIjo4Ni45NzU5MTQwMDE0NjQ4NH0se1wiQm91bmRpbmdCb3hcIjp7XCJIZWlnaHRcIjowLjAzMTk1MDM3NjkyNzg1MjYzLFwiTGVmdFwiOjAuNDU1NzM0MzQyMzM2NjU0NjYsXCJUb3BcIjowLjE2Mzg2MTU4NzY0MzYyMzM1LFwiV2lkdGhcIjowLjAyNzMzMzk4NDE1MTQ4MjU4Mn0sXCJDb25maWRlbmNlXCI6ODMuOTY1MzE2NzcyNDYwOTR9LHtcIkJvdW5kaW5nQm94XCI6e1wiSGVpZ2h0XCI6MC4wOTU1MjUzMzE3OTUyMTU2LFwiTGVmdFwiOjAuNDY3MzA2ODUyMzQwNjk4MjQsXCJUb3BcIjowLjE4MDQ2NTc3Mjc0Nzk5MzQ3LFwiV2lkdGhcIjowLjAzNTMzMDg0NjkwNTcwODMxfSxcIkNvbmZpZGVuY2VcIjo4My41Mzk3MTg2Mjc5Mjk2OX0se1wiQm91bmRpbmdCb3hcIjp7XCJIZWlnaHRcIjowLjAzNDQ0OTIzNDYwNDgzNTUxLFwiTGVmdFwiOjAuMzk2OTAwMTQ3MTk5NjMwNzQsXCJUb3BcIjowLjE3NjI5NjcxMDk2ODAxNzU4LFwiV2lkdGhcIjowLjAyMDIzMjQyOTcyNzkxMTk1fSxcIkNvbmZpZGVuY2VcIjo4Mi4yNTkwMjU1NzM3MzA0N30se1wiQm91bmRpbmdCb3hcIjp7XCJIZWlnaHRcIjowLjA0MzY5NzExNTAzMzg2NDk3NSxcIkxlZnRcIjowLjM5OTczODg0ODIwOTM4MTEsXCJUb3BcIjowLjE1NDM1NDAzNTg1NDMzOTYsXCJXaWR0aFwiOjAuMDI5OTQ2ODk5MDQxNTMzNDd9LFwiQ29uZmlkZW5jZVwiOjgxLjgwNjQ3Mjc3ODMyMDMxfSx7XCJCb3VuZGluZ0JveFwiOntcIkhlaWdodFwiOjAuMDQ0NjQ1MDgyMjA1NTMzOTgsXCJMZWZ0XCI6MC40OTkyODY2ODE0MTM2NTA1LFwiVG9wXCI6MC4xNzQ4OTA3NDE3MDU4OTQ0NyxcIldpZHRoXCI6MC4wMjUyNTI4NzY4MDMyNzg5MjN9LFwiQ29uZmlkZW5jZVwiOjgwLjg2MjcwOTA0NTQxMDE2fSx7XCJCb3VuZGluZ0JveFwiOntcIkhlaWdodFwiOjAuMDMwMDM0OTQyNTUyNDQ3MzIsXCJMZWZ0XCI6MC41Njk0MDY2ODgyMTMzNDg0LFwiVG9wXCI6MC4xNzg0NjY1NDM1NTUyNTk3LFwiV2lkdGhcIjowLjAxNjIyMzkwNzQ3MDcwMzEyNX0sXCJDb25maWRlbmNlXCI6NzEuMjk0Mzk1NDQ2Nzc3MzR9XSxcIk5hbWVcIjpcIlBlcnNvblwiLFwiUGFyZW50c1wiOltdfV19fSJ9LCJpZCI6eyJTIjoic2pWdlZObWliMDRvUUhSY0tFbzZnIn0sImluc2VydGVkQXQiOnsiUyI6IjIwMjMtMDgtMjZUMTY6MDc6MzcuNjQ3WiJ9fSwiU2l6ZUJ5dGVzIjo1OTc5fSwiZXZlbnRTb3VyY2UiOiJhd3M6ZHluYW1vZGIifQ==',
      approximateArrivalTimestamp: 1693066058.085
    }
  ]
))

interface EventPayload {
  eventSource: string;
  eventVersion: '1.0';
  eventID: string;
  eventName: string;
  invokeIdentityArn: string;
  awsRegion: string;
  eventSourceARN: string;
  kinesisSchemaVersion: string;
  partitionKey: string;
  sequenceNumber: string;
  data: string;
  approximateArrivalTimestamp: number;
}

export { main };